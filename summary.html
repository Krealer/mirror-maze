<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mirror Maze - Summary</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="summary">
    <p>Thanks for playing. Your journey has been recorded.</p>
  </div>
  <div id="epilogue" class="epilogue"></div>
  <script src="script.js"></script>
  <script>
    const emotions = JSON.parse(localStorage.getItem('emotions') || '{}');
    const dominant = getDominantEmotion(emotions);
    if (dominant) {
      document.body.classList.add(`emotion-${dominant}`);
      const msg = document.createElement('p');
      msg.textContent = `You journeyed with ${dominant} as your guide.`;
      document.getElementById('summary').appendChild(msg);
    }

    const flashbacks = JSON.parse(localStorage.getItem('triggeredFlashbacks') || '[]');
    if (flashbacks.length) {
      const labels = { hallway: 'The Hallway', promise: 'The Promise' };
      const wrap = document.createElement('p');
      wrap.textContent = 'You remembered: ' + flashbacks.map(id => labels[id] || id).join(', ') + '.';
      document.getElementById('summary').appendChild(wrap);
    }

    const conditionals = JSON.parse(localStorage.getItem('conditionalChoices') || '[]');
    if (conditionals.length) {
      const c = document.createElement('p');
      c.textContent = 'Hidden paths unlocked: ' + conditionals.join(', ') + '.';
      document.getElementById('summary').appendChild(c);
    }

    const nulls = JSON.parse(localStorage.getItem('nullDialogs') || '[]');
    if (nulls.length) {
      const p = document.createElement('p');
      p.textContent = 'Whispers heard: ' + nulls.slice(-2).join(' | ');
      document.getElementById('summary').appendChild(p);
    }

    const manip = JSON.parse(localStorage.getItem('manipulationLog') || '[]');
    if (manip.length) {
      const resisted = manip.filter(m => m.outcome === 'resisted').length;
      const submitted = manip.length - resisted;
      const tactics = [...new Set(manip.map(m => m.tactic))].join(', ');
      const p = document.createElement('p');
      p.textContent = `You resisted ${resisted}/${manip.length} manipulations. Fell for: ${submitted}. Tactics encountered: ${tactics}.`;
      document.getElementById('summary').appendChild(p);
    }
    const skills = JSON.parse(localStorage.getItem("skills") || "{}");
    if (skills.patternSense) {
      const sp = document.createElement("p");
      sp.textContent = `Skill unlocked: Pattern Sense - used ${skills.patternSenseUses || 0} times`;
      document.getElementById("summary").appendChild(sp);
    }
    if (skills.anchorUnlocked) {
      const ap = document.createElement("p");
      ap.textContent = `Skill unlocked: Emotional Anchor - used ${skills.anchorUses || 0} times`;
      document.getElementById("summary").appendChild(ap);
    }

    const journey = JSON.parse(localStorage.getItem('playerJourney') || '[]');
    if (journey.length) {
      const wrap = document.createElement('div');
      wrap.id = 'self-map-final';
      journey.forEach((step, idx) => {
        const div = document.createElement('div');
        div.className = 'self-map-entry';
        div.textContent = `${idx + 1}. ${step.roomId} -> ${step.choiceText} `;
        const span = document.createElement('span');
        span.className = `emotion-tag emotion-color-${step.emotionSnapshot}`;
        span.textContent = step.emotionSnapshot;
        div.appendChild(span);
        wrap.appendChild(div);
      });
      document.body.appendChild(wrap);
    }

    const state = { emotions, triggeredFlashbacks: flashbacks, playerJourney: journey };
    state.dominantEmotion = dominant;
    const ending = getFinalEnding(state);
    const ep = document.getElementById('epilogue');
    const epClass = dominant ? `epilogue--${dominant}` : 'epilogue--neutral';
    ep.classList.add(epClass);
    ep.innerHTML = `<p>${ending.text}</p>`;
    const replay = document.createElement('button');
    replay.setAttribute('aria-label', 'Restart game');
    replay.textContent = 'Re-enter the Maze';
    replay.addEventListener('click', () => { localStorage.clear(); window.location.href = 'maze.html'; });
    ep.appendChild(replay);
    setTimeout(() => ep.classList.add('show'), 300);
  </script>
</body>
</html>
